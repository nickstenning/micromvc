task :default => [:coverage]

desc 'Refresh coverage sources'
task :coverage => [:clobber_coverage, :instrument_coverage]

desc 'Remove generated files'
task :clobber => :clobber_coverage do
  sys.rm 'public/assets/behaviour/production.js'
  sys.rm sys['public/assets/style/**/*-min.css']
end

desc 'Remove instrumented source from jscoverage'
task :clobber_coverage do
  sys.rm_rf 'public/coverage/'
end

task :instrument_coverage do
  sys.cd 'public' do
    sys 'jscoverage',
        '--no-instrument=vendor/',
        '--no-instrument=spec/',
        'app/', 'coverage/'
  end
end

task :stakeout do
  sys 'stakeout', "'rant refresh'", 'public/**/*.js', 'public/**/*.html'
end

desc 'Prepare for a production environment'
task :preprod => ['public/assets/behaviour/production.js', :compress_css]

task :compress_css do
  sys['public/assets/style/**/*.css'].each do |cssfile|
    newname = File.join(File.dirname(cssfile), File.basename(cssfile)[0..-5] + '-min.css')
    sys "java -jar script/yuicompressor-2.2.4.jar -o '#{newname}' '#{cssfile}'"
  end
end

file "public/assets/behaviour/production.js" do
  sys 'ruby script/include.rb --files script/files_list.txt \
                              --destination public/assets/behaviour/production.js \
                              --compressor "java -jar script/yuicompressor-2.2.4.jar"'
end

# META

task :makefile do
  if File.basename($0) == 'make.rb'
    puts "You probably don't want to do this."
  else
    sys 'rant-import -z --force make.rb'
  end
end

task :clobber_makefile do
  if File.basename($0) == 'make.rb'
    puts "You probably don't want to do this."
  else
    sys.rm 'make.rb'
    sys.rm 'make.rb.gz'
  end
end